<div id="preloader">
  <div id="status"><i class="fa fa-spinner fa-spin"></i></div>
</div>
<div class="contentpanel">
  <div class="panel panel-body">
    <header style="text-align: center">
      <h4>货品库存页面</h4>
      <p>已选类别：<%= @type %></p>
      <p>已选商品：<%= @name %></p>
    </header>

    <div class="content-body">
      <div class="panel">
        <div class="panel-heading" style="background-color: #fff; display: flex; align-items: center; justify-content: space-between;">
          <%= form_tag commodity_inventories_path, method: :get do%>
            <div style="display: flex; align-items: center;">
            <label >请选择商品类别：</label>
            <select class="form-control" name="commodity_type" style="width:200px;height:35px;">
              <% @commodity_types.each do |commodity_type| %>
                <option value="<%= commodity_type %>"><%= commodity_type%></option>
              <% end %>
            </select>
            <label >请选择商品名称：</label>
            <select class="form-control" name="commodity_name[]" id="commodity_select3" multiple="multiple" style="width:200px;height:20px;">
              <% @commodity_names.each do |commodity_name| %>
                <option value="<%= commodity_name %>"><%= commodity_name%></option>
              <% end %>
            </select>
            <%= submit_tag :筛选 %>
            </div>
          <% end %>
 
          <span style="display:inline-block;">
          </span>
          <span>
            <%= link_to("导入库存表", "#", class:"btn btn-primary-upload pull-right", "data-toggle" => "modal", "data-target" => "#uploadModal") %>            
            <div class="btn-group">
              <button type="button" class="btn btn-primary-upload dropdown-toggle" data-toggle="dropdown">
                下载表格
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu dropdown-menu-usermenu pull-right">
                <li><%= link_to '下载表格模板', download_template_commodity_inventories_path(type: @type, commodity_ids: @commodities.pluck(:id), format: "xls") %></li>
                <li><%= link_to "下载库存数据", commodity_inventories_path(type: @type, commodity_ids: @commodities.pluck(:id), format: "xls") %></li>
              </ul>
            </div>

          </span>
        </div> 
      </div> 
      <div class="content-table" style="clear:both;">
        <table>
          <thead> 
            <tr>
              <th>商品类别</th>
              <th>商品名称</th>
              <% if !(@type == "服装类") %>
                <th>保质期</th>
                <th>生产日期</th>
                <th>剩余天数</th>
              <% end %>
              <th>计量单位</th>
              <th>规格型号</th>
              <th>当前库存</th>
              <!--  <th>操作</th> -->
              <th>出入库记录</th>
            </tr>
          </thead>
          <tbody>
            <% @commodities.each do |commodity| %>
              <% inventory = CommodityInventory.find_by(commodity_id: commodity.id) %>
              <% product_dates = CommodityInventory.where(commodity_id: commodity.id).pluck(:produce_date).uniq %>
              <% product_dates.each do |date| %>
                <tr>
                  <td><%= commodity.commodity_type_name %></td>
                  <td><%= commodity.name %></td>   
                  <% if !(@type == "服装类") %>              
                    <td><%= inventory.warranty_period %>天</td>
                    <td><%= date.to_datetime.strftime("%Y年%m月%d日") %></td>
                    <td><%= (inventory.warranty_period - (Time.now - date.to_datetime)/60/60/24).round %>天</td>
                  <% end %>
                  <td><%= commodity.unit %></td>
                  <td><%= commodity.standard %></td>
                  <td><%= CommodityCurrentInventory.find_by(commodity_id: inventory.commodity_id, produce_date: date).current_inventory  %></td>
                  <!--  <td><%= link_to("入库", show_modal_commodity_inventories_path(commodity_id: commodity.id), remote: true, "data-toggle" => "modal", "data-target" => "#myModal",class:"btn btn-primary btn-xs") %></td> -->
                  <td><%= link_to("查看记录", commodity_inventory_path(commodity.id), class:"btn btn-primary btn-xs") %></td>
                </tr>
              <% end %>
            <% end %>
            <% total_inventory = CommodityCurrentInventory.where(commodity_id: @commodities.pluck(:id)).sum(:current_inventory) %>
            <tr>
            <td style="font-weight: 700">库存合计</td>
            <td colspan="7"><%= total_inventory %></td>            
          </tr>
          </tbody>
        </table>      
      </div>
    </div>
  </div>
 </div>


<!-- 
<div id="showModal">
  <%= render 'show_modal' %>
</div>
-->

<!-- 上传表格弹框代码-开始 -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="margin-top:100px;">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
        <h4 class="modal-title" id="myModalLabel">
          上传商品库存表
        </h4>
      </div>
      <div class="modal-body">      
        <%= form_tag import_commodity_commodities_path, method: 'post', multipart: true do %>
          <div class="star_import_model_file_style">
            <ul class ="star_import_model">
              <li>
                <%= file_field_tag :file,required: true %>
              </li>
            </ul>
          </div>
          <div class="" style="">
             <%= submit_tag :点击确定,:data => {disable_with: "附件上传中 ... "},:class => "btn btn-primary-status" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<!-- 上传表格弹框代码-结束 -->

<script>
  $("#commodity_select2").select2( { theme: "bootstrap"});
  $("#commodity_select3").select2( { theme: "bootstrap"});
</script>