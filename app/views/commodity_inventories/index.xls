<?xml version="1.0"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:x="urn:schemas-microsoft-com:office:excel"
  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:html="http://www.w3.org/TR/REC-html40">
  <Worksheet ss:Name="Sheet1">
    <Table>
      <Row>
        <Cell><Data ss:Type="String">商品类别</Data></Cell>
        <Cell><Data ss:Type="String">商品名称</Data></Cell>
        <Cell><Data ss:Type="String">保质期</Data></Cell>
        <Cell><Data ss:Type="String">生产日期</Data></Cell>
        <Cell><Data ss:Type="String">剩余天数</Data></Cell>
        <Cell><Data ss:Type="String">计量单位</Data></Cell>
        <Cell><Data ss:Type="String">规格型号</Data></Cell>
        <Cell><Data ss:Type="String">当前库存</Data></Cell>
      </Row>
    <% @commodities.each do |commodity| %>
      <% inventory = CommodityInventory.find_by(commodity_id: commodity.id) %>
        <% product_dates = CommodityInventory.where(commodity_id: commodity.id).pluck(:produce_date).uniq %>
        <% product_dates.each do |date| %>
          <Row>
            <Cell><Data ss:Type="String"><%= commodity.commodity_type_name %></Data></Cell>
            <Cell><Data ss:Type="String"><%= commodity.name %></Data></Cell>
            <Cell><Data ss:Type="String"><%= inventory.warranty_period %>天</Data></Cell>
            <Cell><Data ss:Type="String"><%= date.to_datetime.strftime("%Y年%m月%d日") %></Data></Cell>
            <Cell><Data ss:Type="String"><%= (inventory.warranty_period - (Time.now - date.to_datetime)/60/60/24).round %>天</Data></Cell>
            <Cell><Data ss:Type="String"><%= commodity.unit %></Data></Cell>
            <Cell><Data ss:Type="String"><%= commodity.standard %></Data></Cell>
            <Cell><Data ss:Type="String"></Data><%= CommodityCurrentInventory.find_by(commodity_id: inventory.commodity_id, produce_date: date).current_inventory  %></Cell>
          </Row>
        <% end %>
    <% end %>
    <% total_inventory = CommodityCurrentInventory.where(commodity_id: @commodities.pluck(:id)).sum(:current_inventory) %>
    <Cell><Data ss:Type="String">统计</Data></Cell>
    <Cell><Data ss:Type="String"></Data></Cell>
    <Cell><Data ss:Type="String"></Data></Cell>
    <Cell><Data ss:Type="String"></Data></Cell>
    <Cell><Data ss:Type="String"></Data></Cell>
    <Cell><Data ss:Type="String"></Data></Cell>
    <Cell><Data ss:Type="String"></Data></Cell>
    <Cell><Data ss:Type="String"><%= total_inventory %></Data></Cell>
  </Table>
 </Worksheet>
</Workbook>